<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panini Custom AI - AL DOGE</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --gold: #d4af37;
      --dark: #0b0b0b;
      --soft: #1a1a1a;
      --text: #f5f5f5;
      --muted: #b3b3b3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--dark);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      padding-bottom: 100px;
    }

    .logo-fixed {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      width: 60px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      cursor: pointer;
    }

    .cart-fixed {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
      background: var(--gold);
      color: black;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
    }

    .cart-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    header {
      padding: 100px 20px 40px;
      text-align: center;
      background: linear-gradient(180deg, var(--soft) 0%, var(--dark) 100%);
    }

    h1 {
      font-family: 'Playfair Display', serif;
      color: var(--gold);
      font-size: clamp(36px, 6vw, 56px);
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 18px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .preset-btn {
      padding: 20px;
      border-radius: 15px;
      border: 2px solid rgba(212, 175, 55, 0.3);
      background: var(--soft);
      color: var(--text);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .preset-btn:hover {
      border-color: var(--gold);
      transform: translateY(-3px);
    }

    .preset-btn .emoji {
      font-size: 32px;
    }

    .custom-section {
      background: var(--soft);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .custom-section h2 {
      color: var(--gold);
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
    }

    .custom-input {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid rgba(212, 175, 55, 0.3);
      background: var(--dark);
      color: var(--text);
      font-size: 16px;
      margin-bottom: 15px;
    }

    .custom-input::placeholder {
      color: var(--muted);
    }

    .ask-ai-btn {
      width: 100%;
      padding: 15px;
      border-radius: 10px;
      border: none;
      background: var(--gold);
      color: black;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .ask-ai-btn:hover {
      transform: scale(1.02);
    }

    .ask-ai-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .result-section {
      background: var(--soft);
      padding: 30px;
      border-radius: 15px;
      display: none;
    }

    .result-section.show {
      display: block;
    }

    .ai-description {
      color: var(--muted);
      margin-bottom: 20px;
      font-style: italic;
      text-align: center;
    }

    .ingredients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 25px;
    }

    .ingredient-item {
      background: var(--dark);
      padding: 12px 15px;
      border-radius: 8px;
      border: 2px solid rgba(212, 175, 55, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .ingredient-item.selected {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
    }

    .ingredient-item:hover {
      border-color: var(--gold);
    }

    .ingredient-name {
      font-size: 14px;
    }

    .ingredient-checkbox {
      width: 20px;
      height: 20px;
      accent-color: var(--gold);
    }

    .price-section {
      text-align: center;
      padding: 20px;
      background: var(--dark);
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .price-label {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .price-value {
      color: var(--gold);
      font-size: 36px;
      font-weight: 600;
    }

    .price-detail {
      color: var(--muted);
      font-size: 12px;
      margin-top: 5px;
    }

    .add-to-cart-final {
      width: 100%;
      padding: 18px;
      border-radius: 10px;
      border: none;
      background: var(--gold);
      color: black;
      font-weight: 600;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .add-to-cart-final:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }

    .spinner {
      border: 3px solid rgba(212, 175, 55, 0.3);
      border-top: 3px solid var(--gold);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .preset-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <img src="logo-al-doge.png" class="logo-fixed" onclick="window.location.href='home.html'" alt="AL DOGE">

  <div class="cart-fixed" onclick="window.location.href='carrello.html'">
    üõí
    <span class="cart-badge" id="cart-badge" style="display: none;">0</span>
  </div>

  <header>
    <h1>ü•ñ Panini Custom AI</h1>
    <p class="subtitle">Crea il tuo panino personalizzato con l'intelligenza artificiale</p>
  </header>

  <div class="container">
    <!-- Preset Buttons -->
    <div class="preset-buttons">
      <button class="preset-btn" onclick="selectPreset('leggero')">
        <span class="emoji">ü•í</span>
        <span>Leggero</span>
      </button>
      <button class="preset-btn" onclick="selectPreset('piccante')">
        <span class="emoji">üå∂Ô∏è</span>
        <span>Piccante</span>
      </button>
      <button class="preset-btn" onclick="selectPreset('vegetariano')">
        <span class="emoji">ü•¨</span>
        <span>Vegetariano</span>
      </button>
      <button class="preset-btn" onclick="selectPreset('proteico')">
        <span class="emoji">üí™</span>
        <span>Proteico</span>
      </button>
    </div>

    <!-- Custom Request -->
    <div class="custom-section">
      <h2>‚ú® Oppure descrivi cosa vuoi</h2>
      <input 
        type="text" 
        id="custom-input" 
        class="custom-input" 
        placeholder="Es: Voglio qualcosa di fresco e saporito..."
      >
      <button class="ask-ai-btn" onclick="askCustomAI()" id="ask-btn">
        ü§ñ Chiedi all'AI
      </button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading" style="display: none;">
      <div class="spinner"></div>
      <p>L'AI sta creando il tuo panino perfetto...</p>
    </div>

    <!-- Result Section -->
    <div class="result-section" id="result-section">
      <h2 style="color: var(--gold); text-align: center; margin-bottom: 15px;">Il Tuo Panino</h2>
      <p class="ai-description" id="ai-description"></p>
      
      <h3 style="color: var(--text); margin-bottom: 15px;">Ingredienti (clicca per togliere/aggiungere):</h3>
      <div class="ingredients-grid" id="ingredients-grid"></div>
      
      <div class="price-section">
        <div class="price-label">Prezzo Totale</div>
        <div class="price-value" id="total-price">‚Ç¨5.00</div>
        <div class="price-detail" id="price-detail">Base ‚Ç¨5.00 + 0 ingredienti</div>
      </div>
      
      <button class="add-to-cart-final" onclick="addPaninoToCart()">
        üõí Aggiungi al Carrello
      </button>
    </div>
  </div>

  <script src="cart-utils.js"></script>
  <script>
    let selectedIngredients = [];
    let aiSuggestion = null;

    async function selectPreset(type) {
      showLoading();
      
      try {
        const response = await fetch('/.netlify/functions/groq-panini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ preset: type })
        });
        
        const data = await response.json();
        handleAIResponse(data);
      } catch (error) {
        console.error('Errore:', error);
        alert('Errore nel contattare l\'AI. Riprova.');
        hideLoading();
      }
    }

    async function askCustomAI() {
      const input = document.getElementById('custom-input').value.trim();
      if (!input) {
        alert('Scrivi cosa desideri nel panino!');
        return;
      }
      
      showLoading();
      
      try {
        const response = await fetch('/.netlify/functions/groq-panini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ richiesta: input })
        });
        
        const data = await response.json();
        handleAIResponse(data);
      } catch (error) {
        console.error('Errore:', error);
        alert('Errore nel contattare l\'AI. Riprova.');
        hideLoading();
      }
    }

    function handleAIResponse(data) {
      hideLoading();
      
      aiSuggestion = data;
      selectedIngredients = [...data.ingredienti];
      
      document.getElementById('ai-description').textContent = data.descrizione;
      renderIngredients();
      updatePrice();
      
      document.getElementById('result-section').classList.add('show');
      document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
    }

    function renderIngredients() {
      const grid = document.getElementById('ingredients-grid');
      
      // Tutti gli ingredienti disponibili
      const allIngredients = INGREDIENTI_DISPONIBILI;
      
      grid.innerHTML = allIngredients.map(ing => {
        const isSelected = selectedIngredients.includes(ing);
        return `
          <div class="ingredient-item ${isSelected ? 'selected' : ''}" onclick="toggleIngredient('${ing}')">
            <span class="ingredient-name">${ing}</span>
            <input type="checkbox" class="ingredient-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation()">
          </div>
        `;
      }).join('');
    }

    function toggleIngredient(ingredient) {
      const index = selectedIngredients.indexOf(ingredient);
      if (index > -1) {
        selectedIngredients.splice(index, 1);
      } else {
        selectedIngredients.push(ingredient);
      }
      
      renderIngredients();
      updatePrice();
    }

    function updatePrice() {
      const numIngredients = selectedIngredients.length;
      const total = PREZZO_BASE_PANINO + (numIngredients * PREZZO_INGREDIENTE);
      
      document.getElementById('total-price').textContent = `‚Ç¨${total.toFixed(2)}`;
      document.getElementById('price-detail').textContent = 
        `Base ‚Ç¨${PREZZO_BASE_PANINO.toFixed(2)} + ${numIngredients} ingredienti (‚Ç¨${PREZZO_INGREDIENTE.toFixed(2)} cad.)`;
    }

    function addPaninoToCart() {
      if (selectedIngredients.length === 0) {
        alert('Seleziona almeno un ingrediente!');
        return;
      }
      
      const numIngredients = selectedIngredients.length;
      const price = PREZZO_BASE_PANINO + (numIngredients * PREZZO_INGREDIENTE);
      
      const item = {
        type: 'panino',
        name: 'Panino Custom AL DOGE',
        price: price,
        ingredients: selectedIngredients,
        allergeni: [1, 7], // Impasto pizza contiene glutine e lattosio
        quantity: 1
      };
      
      CartManager.addItem(item);
      
      // Feedback visivo
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚úì Aggiunto al Carrello!';
      btn.style.background = '#4CAF50';
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
      }, 2000);
      
      // Reset form
      setTimeout(() => {
        document.getElementById('result-section').classList.remove('show');
        document.getElementById('custom-input').value = '';
        selectedIngredients = [];
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 2500);
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result-section').classList.remove('show');
      document.getElementById('ask-btn').disabled = true;
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('ask-btn').disabled = false;
    }

    // Inizializza
    CartManager.updateBadge();
  </script>
</body>
</html>
