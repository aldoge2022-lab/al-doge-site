let ultimiConsigli = [];

exports.handler = async function(event) {
  try {
    const { richiesta } = JSON.parse(event.body);

    const menu = `
Pizze:
- La Friulana (850 kcal): pomodoro, mozzarella, patate al forno, salame dolce, cipolla
- La Doge Special (920 kcal): pomodoro, mozzarella, speck, gorgonzola, noci
- Margherita (700 kcal): pomodoro, mozzarella
- Diavola (880 kcal): pomodoro, mozzarella, salame piccante

Panini:
- Prosciutto e Rucola (600 kcal)
- Speck e Formaggio (720 kcal)
- Vegetariano (550 kcal)

Bevande:
- Birra artigianale chiara
- Birra rossa
- Coca-Cola
- Acqua naturale
- Acqua frizzante
- Vino rosso della casa
- Vino bianco della casa
`;

    const memoria = ultimiConsigli.length > 0 
      ? `Evita di consigliare: ${ultimiConsigli.join(", ")}`
      : "Puoi scegliere liberamente.";

    const prompt = `
Sei il consulente gastronomico premium della pizzeria AL DOGE.

Menu:
${menu}

Cliente scrive: "${richiesta}"

${memoria}

Regole:
- Consiglia UNA sola proposta principale (pizza o panino)
- Indica le calorie stimate
- Suggerisci una bevanda in abbinamento
- Spiega brevemente il motivo dell'abbinamento
- Massimo 4 frasi eleganti
- Tono professionale ma caloroso
`;

    const response = await fetch("https://api.x.ai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${process.env.GROK_API_KEY}`
      },
      body: JSON.stringify({
        model: "grok-2-latest",
        messages: [
          { role: "system", content: "Sei uno chef italiano esperto in abbinamenti gastronomici." },
          { role: "user", content: prompt }
        ],
        temperature: 0.9
      })
    });

    const data = await response.json();
    const testo = data.choices?.[0]?.message?.content || 
      "Non riusciamo a consigliarti ora. Chiamaci ðŸ˜‰";

    // MEMORIA: salva ultimo piatto consigliato
    const match = testo.match(/La [A-Za-z ]+|Margherita|Diavola|Prosciutto e Rucola|Speck e Formaggio|Vegetariano/);
    if (match) {
      ultimiConsigli.push(match[0]);
      if (ultimiConsigli.length > 3) {
        ultimiConsigli.shift();
      }
    }

    return {
      statusCode: 200,
      body: JSON.stringify({ risposta: testo })
    };

  } catch (error) {
    return {
      statusCode: 500,
      body: JSON.stringify({ risposta: "Errore AI. Chiamaci per un consiglio diretto." })
    };
  }
};
