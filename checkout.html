<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout – AL DOGE</title>

    <link rel="stylesheet" href="css/style.css">
</head>

<body>

<header>
    <h1>Checkout</h1>
    <a href="index.html">← Torna al menu</a>
</header>

<main>

    <section>
        <h2>Riepilogo ordine</h2>
        <div id="riepilogo"></div>
        <p id="totale" class="totale"></p>
    </section>

    <section>
        <h2>Dati cliente</h2>

        <form id="form-checkout">
            <label>Nome e Cognome</label>
            <input type="text" id="nome" required>

            <label>Telefono</label>
            <input type="text" id="telefono" required>

            <label>Note (opzionale)</label>
            <textarea id="note"></textarea>

            <button type="submit">Invia ordine</button>
        </form>
    </section>

</main>

<footer>
    <p>© 2026 AL DOGE – Majano</p>
</footer>

<script src="js/prodotti.js"></script>
<script src="js/cart.js"></script>

<script>
// ===============================
//  MOSTRA RIEPILOGO CARRELLO
// ===============================

function mostraRiepilogo() {
    const carrello = getCarrello();
    const div = document.getElementById("riepilogo");

    if (carrello.length === 0) {
        div.innerHTML = "<p>Il carrello è vuoto.</p>";
        return;
    }

    carrello.forEach(item => {
        const riga = document.createElement("div");
        riga.className = "riga-riepilogo";

        riga.innerHTML = `
            <span>${item.nome} (x${item.quantita})</span>
            <span>€ ${(item.prezzo * item.quantita).toFixed(2)}</span>
        `;

        div.appendChild(riga);
    });

    document.getElementById("totale").textContent =
        "Totale: € " + calcolaTotale().toFixed(2);
}

document.addEventListener("DOMContentLoaded", mostraRiepilogo);


// ===============================
//  INVIO ORDINE A NETLIFY
// ===============================

document.getElementById("form-checkout").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nome").value.trim();
    const telefono = document.getElementById("telefono").value.trim();
    const note = document.getElementById("note").value.trim();
    const carrello = getCarrello();

    if (!nome || !telefono || carrello.length === 0) {
        alert("Compila tutti i campi e assicurati che il carrello non sia vuoto.");
        return;
    }

    const ordine = {
        nome,
        telefono,
        note,
        carrello,
        totale: calcolaTotale()
    };

    const risposta = await fetch("/.netlify/functions/invia-ordine", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(ordine)
    });

    const risultato = await risposta.json();

    if (risultato.ok) {
        svuotaCarrello();
        window.location.href = "success.html";
    } else {
        alert("Errore nell'invio dell'ordine. Riprova.");
    }
});
</script>

</body>
</html>
