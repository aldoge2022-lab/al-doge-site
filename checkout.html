<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - AL DOGE</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    :root {
      --gold: #d4af37;
      --dark: #0b0b0b;
      --soft: #1a1a1a;
      --text: #f5f5f5;
      --muted: #b3b3b3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--dark);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      padding-bottom: 100px;
    }

    .logo-fixed {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 999;
      width: 60px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      cursor: pointer;
    }

    header {
      padding: 100px 20px 40px;
      text-align: center;
      background: linear-gradient(180deg, var(--soft) 0%, var(--dark) 100%);
    }

    h1 {
      font-family: 'Playfair Display', serif;
      color: var(--gold);
      font-size: clamp(36px, 6vw, 56px);
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--muted);
      font-size: 18px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .steps-indicator {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: var(--soft);
      border-radius: 25px;
      border: 2px solid rgba(212, 175, 55, 0.2);
    }

    .step.active {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.1);
    }

    .step.completed {
      border-color: #4CAF50;
      background: rgba(76, 175, 80, 0.1);
    }

    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--gold);
      color: black;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .step.completed .step-number {
      background: #4CAF50;
      color: white;
    }

    .step-label {
      font-size: 14px;
      font-weight: 500;
    }

    .section {
      background: var(--soft);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      display: none;
    }

    .section.active {
      display: block;
    }

    .section h2 {
      color: var(--gold);
      font-size: 24px;
      margin-bottom: 25px;
      font-family: 'Playfair Display', serif;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      color: var(--text);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-label .required {
      color: #ff4444;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid rgba(212, 175, 55, 0.3);
      background: var(--dark);
      color: var(--text);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
    }

    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .time-slot {
      padding: 12px;
      border: 2px solid rgba(212, 175, 55, 0.3);
      border-radius: 8px;
      background: var(--dark);
      color: var(--text);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      font-size: 14px;
    }

    .time-slot:hover {
      border-color: var(--gold);
    }

    .time-slot.selected {
      border-color: var(--gold);
      background: rgba(212, 175, 55, 0.2);
      font-weight: 600;
    }

    .time-slot.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .order-summary {
      background: var(--dark);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    .summary-item:last-child {
      border-bottom: none;
      margin-top: 10px;
      padding-top: 15px;
      border-top: 2px solid var(--gold);
    }

    .summary-total {
      font-size: 24px;
      font-weight: 600;
      color: var(--gold);
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .btn-back {
      flex: 1;
      padding: 15px;
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold);
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-back:hover {
      background: rgba(212, 175, 55, 0.1);
    }

    .btn-next {
      flex: 2;
      padding: 15px;
      background: var(--gold);
      border: none;
      color: black;
      border-radius: 10px;
      font-weight: 600;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-next:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      color: #ff9999;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .success-message {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid #4CAF50;
      color: #81C784;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .success-icon {
      font-size: 60px;
      margin-bottom: 15px;
    }

    #payment-element {
      margin: 20px 0;
    }

    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
      }

      .time-slots {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }
  </style>
</head>

<body>
  <img src="logo-al-doge.png" class="logo-fixed" onclick="window.location.href='home.html'" alt="AL DOGE">

  <header>
    <h1>üí≥ Checkout</h1>
    <p class="subtitle">Completa il tuo ordine</p>
  </header>

  <div class="container">
    <!-- Steps Indicator -->
    <div class="steps-indicator">
      <div class="step active" id="step-1-indicator">
        <div class="step-number">1</div>
        <div class="step-label">Dati Cliente</div>
      </div>
      <div class="step" id="step-2-indicator">
        <div class="step-number">2</div>
        <div class="step-label">Orario Ritiro</div>
      </div>
      <div class="step" id="step-3-indicator">
        <div class="step-number">3</div>
        <div class="step-label">Pagamento</div>
      </div>
    </div>

    <!-- Step 1: Customer Data -->
    <div class="section active" id="step-1">
      <h2>üìù I Tuoi Dati</h2>
      
      <div class="form-group">
        <label class="form-label">Nome e Cognome <span class="required">*</span></label>
        <input type="text" class="form-input" id="customer-name" placeholder="Mario Rossi" required>
      </div>

      <div class="form-group">
        <label class="form-label">Telefono <span class="required">*</span></label>
        <input type="tel" class="form-input" id="customer-phone" placeholder="+39 333 1234567" required>
      </div>

      <div class="form-group">
        <label class="form-label">Note per l'ordine (opzionale)</label>
        <textarea class="form-textarea" id="customer-notes" placeholder="Es: Senza cipolla, allergia ai crostacei, ecc."></textarea>
      </div>

      <div class="action-buttons">
        <button class="btn-back" onclick="window.location.href='carrello.html'">‚Üê Torna al Carrello</button>
        <button class="btn-next" onclick="goToStep2()">Avanti ‚Üí</button>
      </div>
    </div>

    <!-- Step 2: Pickup Time -->
    <div class="section" id="step-2">
      <h2>üïê Orario di Ritiro</h2>
      
      <div class="form-group">
        <label class="form-label">Seleziona il giorno <span class="required">*</span></label>
        <select class="form-select" id="pickup-date" onchange="generateTimeSlots()">
          <option value="">-- Seleziona --</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Seleziona l'orario <span class="required">*</span></label>
        <div class="time-slots" id="time-slots"></div>
      </div>

      <div class="action-buttons">
        <button class="btn-back" onclick="goToStep1()">‚Üê Indietro</button>
        <button class="btn-next" onclick="goToStep3()" id="step2-next">Avanti ‚Üí</button>
      </div>
    </div>

    <!-- Step 3: Payment -->
    <div class="section" id="step-3">
      <h2>üí≥ Riepilogo e Pagamento</h2>
      
      <div class="order-summary" id="order-summary"></div>
      
      <div id="payment-element"></div>
      
      <div class="error-message" id="payment-error" style="display: none;"></div>
      
      <div class="action-buttons">
        <button class="btn-back" onclick="goToStep2()">‚Üê Indietro</button>
        <button class="btn-next" onclick="submitPayment()" id="pay-button">üí≥ Paga e Conferma</button>
      </div>
    </div>

    <!-- Success Message -->
    <div class="section" id="step-success">
      <div class="success-message">
        <div class="success-icon">‚úì</div>
        <h2 style="color: #4CAF50; margin-bottom: 15px;">Ordine Confermato!</h2>
        <p style="color: var(--muted); margin-bottom: 20px;">
          Grazie per il tuo ordine! Riceverai una notifica quando sar√† pronto.
        </p>
        <p style="color: var(--text); font-weight: 600;">
          Numero ordine: <span id="order-number" style="color: var(--gold);"></span>
        </p>
        <button class="btn-next" onclick="window.location.href='home.html'" style="margin-top: 20px;">
          Torna alla Home
        </button>
      </div>
    </div>
  </div>

  <script src="cart-utils.js"></script>
  <script>
    let currentStep = 1;
    let selectedTime = null;
    let stripe = null;
    let elements = null;
    let paymentElement = null;

    // Inizializza Stripe (usa test key per ora)
    const STRIPE_PUBLIC_KEY = 'pk_test_51QmZ7YRz9m0xxxxxxxxxxxxx'; // Da sostituire con la vera chiave

    function initStripe() {
      // Per demo, usiamo una simulazione
      // In produzione, sostituire con: stripe = Stripe(STRIPE_PUBLIC_KEY);
      console.log('Stripe initialized (demo mode)');
    }

    function goToStep1() {
      currentStep = 1;
      updateSteps();
    }

    function goToStep2() {
      // Valida step 1
      const name = document.getElementById('customer-name').value.trim();
      const phone = document.getElementById('customer-phone').value.trim();

      if (!name || !phone) {
        alert('Compila tutti i campi obbligatori!');
        return;
      }

      currentStep = 2;
      updateSteps();
      generateDates();
    }

    function goToStep3() {
      // Valida step 2
      const date = document.getElementById('pickup-date').value;
      
      if (!date || !selectedTime) {
        alert('Seleziona data e orario di ritiro!');
        return;
      }

      currentStep = 3;
      updateSteps();
      displayOrderSummary();
      initStripe();
    }

    function updateSteps() {
      // Nascondi tutte le sezioni
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.step').forEach(s => {
        s.classList.remove('active', 'completed');
      });

      // Mostra sezione corrente
      document.getElementById(`step-${currentStep}`).classList.add('active');
      
      // Aggiorna indicatori
      for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step-${i}-indicator`);
        if (i < currentStep) {
          indicator.classList.add('completed');
        } else if (i === currentStep) {
          indicator.classList.add('active');
        }
      }
    }

    function generateDates() {
      const select = document.getElementById('pickup-date');
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const formatDate = (date) => {
        return date.toISOString().split('T')[0];
      };

      const formatLabel = (date) => {
        const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
        const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
      };

      select.innerHTML = `
        <option value="">-- Seleziona --</option>
        <option value="${formatDate(today)}">Oggi - ${formatLabel(today)}</option>
        <option value="${formatDate(tomorrow)}">Domani - ${formatLabel(tomorrow)}</option>
      `;
    }

    function generateTimeSlots() {
      const container = document.getElementById('time-slots');
      const selectedDate = document.getElementById('pickup-date').value;
      
      if (!selectedDate) {
        container.innerHTML = '';
        return;
      }

      // Orari: 18:30 - 23:00, slot ogni 15 minuti
      const slots = [];
      let hour = 18;
      let minute = 30;

      while (hour < 23 || (hour === 23 && minute === 0)) {
        const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        slots.push(timeStr);
        
        minute += 15;
        if (minute >= 60) {
          minute = 0;
          hour++;
        }
      }

      container.innerHTML = slots.map(slot => `
        <div class="time-slot" onclick="selectTime('${slot}')" data-time="${slot}">
          ${slot}
        </div>
      `).join('');

      selectedTime = null;
    }

    function selectTime(time) {
      selectedTime = time;
      document.querySelectorAll('.time-slot').forEach(slot => {
        slot.classList.remove('selected');
      });
      document.querySelector(`[data-time="${time}"]`).classList.add('selected');
    }

    function displayOrderSummary() {
      const cart = CartManager.getCart();
      const name = document.getElementById('customer-name').value;
      const phone = document.getElementById('customer-phone').value;
      const date = document.getElementById('pickup-date').value;
      const notes = document.getElementById('customer-notes').value;

      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      const summary = document.getElementById('order-summary');
      summary.innerHTML = `
        <div class="summary-item">
          <span>üë§ Nome:</span>
          <span>${name}</span>
        </div>
        <div class="summary-item">
          <span>üìû Telefono:</span>
          <span>${phone}</span>
        </div>
        <div class="summary-item">
          <span>üïê Ritiro:</span>
          <span>${new Date(date).toLocaleDateString('it-IT')} - ${selectedTime}</span>
        </div>
        ${notes ? `
        <div class="summary-item">
          <span>üìù Note:</span>
          <span>${notes}</span>
        </div>
        ` : ''}
        <div class="summary-item">
          <span>üì¶ Articoli:</span>
          <span>${cart.length}</span>
        </div>
        <div class="summary-item summary-total">
          <span>Totale:</span>
          <span>‚Ç¨${total.toFixed(2)}</span>
        </div>
      `;
    }

    async function submitPayment() {
      const btn = document.getElementById('pay-button');
      btn.disabled = true;
      btn.textContent = 'Elaborazione...';

      // Simula pagamento (in produzione usare Stripe Payment Intent)
      setTimeout(async () => {
        // Salva ordine
        const orderId = await saveOrder();
        
        // Mostra successo
        document.getElementById('order-number').textContent = `#${orderId}`;
        document.getElementById('step-success').classList.add('active');
        document.getElementById('step-3').classList.remove('active');
        
        // Svuota carrello
        CartManager.clearCart();
        
        btn.disabled = false;
        btn.textContent = 'üí≥ Paga e Conferma';
      }, 2000);
    }

    async function saveOrder() {
      const cart = CartManager.getCart();
      const order = {
        orderId: Date.now(),
        timestamp: new Date().toISOString(),
        customer: {
          name: document.getElementById('customer-name').value,
          phone: document.getElementById('customer-phone').value,
          notes: document.getElementById('customer-notes').value
        },
        pickup: {
          date: document.getElementById('pickup-date').value,
          time: selectedTime
        },
        items: cart,
        total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        status: 'paid'
      };

      // Salva in localStorage (in produzione usare Firebase/backend)
      const orders = JSON.parse(localStorage.getItem('aldoge_orders') || '[]');
      orders.push(order);
      localStorage.setItem('aldoge_orders', JSON.stringify(orders));

      // Invia notifica Telegram (chiamata a Netlify function)
      try {
        await fetch('/.netlify/functions/telegram-notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
      } catch (error) {
        console.error('Errore notifica Telegram:', error);
      }

      return order.orderId;
    }

    // Inizializza
    if (CartManager.getCart().length === 0) {
      alert('Il carrello √® vuoto!');
      window.location.href = 'home.html';
    }
  </script>
</body>
</html>
